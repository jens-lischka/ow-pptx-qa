# ============================================================
# OW PPTX QA Tool — GitHub Actions Workflow
#
# This workflow does two things on every push to main:
#   1. Runs backend tests (Python) using the ANTHROPIC_API_KEY secret
#   2. Deploys the task pane files to GitHub Pages
#
# Required GitHub Secrets:
#   - ANTHROPIC_API_KEY  (set in repo Settings → Secrets → Actions)
# ============================================================

name: CI & Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:

  # ── Job 1: Test Python backend ─────────────────────────────
  test-backend:
    name: Test QA Backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'qa/requirements.txt'

      - name: Install dependencies
        run: |
          cd qa
          pip install -r requirements.txt

      - name: Run backend health check
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cd qa
          # Start server in background, wait for it, hit health endpoint
          uvicorn main:app --port 8000 &
          sleep 5
          curl -f http://localhost:8000/health
          kill %1

      - name: Run QA smoke test
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cd qa
          uvicorn main:app --port 8000 &
          sleep 5
          curl -f -X POST http://localhost:8000/qa \
            -H "Content-Type: application/json" \
            -d '{
              "slides": [{
                "index": 1,
                "shapes": [{
                  "name": "Title 1",
                  "type": "text",
                  "text": "Market Analysis",
                  "fonts": [{"name": "Arial", "size": 24, "color": "333333"}]
                }]
              }]
            }'
          kill %1

  # ── Job 2: Deploy to GitHub Pages ──────────────────────────
  deploy-pages:
    name: Deploy Task Pane to GitHub Pages
    runs-on: ubuntu-latest
    needs: test-backend          # Only deploy if backend tests pass
    if: github.ref == 'refs/heads/main'

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # Deploy the entire repo root so manifest.xml and src/ are accessible
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
